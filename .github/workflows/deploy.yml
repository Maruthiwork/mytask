name: Deploy Hello World HTML to GCP VM

on:
  push:
    branches:
      - main  # Trigger action on commits to the 'main' branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0
        with:
          version: 'latest'

      - name: Authenticate to GCP
        run: echo "${{ secrets.GCP_SA_KEY }}" > /home/gcloud-service-key.json
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud authentication
        run: gcloud auth activate-service-account --key-file=/home/gcloud-service-key.json

      - name: Set GCP project
        run: gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

      - name: Deploy Hello World HTML to GCP VM
        run: |
          # SSH into the VM and copy the HTML file
          gcloud compute ssh --project ${{ secrets.GCP_PROJECT_ID }} --zone us-central1-a --tunnel-through-iap --ssh-flag="-o StrictHostKeyChecking=no" ${{ secrets.GCP_VM_IP }} << 'EOF'
            sudo mkdir maruthi
            # Navigate to the web server directory (e.g., /var/www/html/)
            #sudo mkdir -p /var/www/html/
            #sudo cp /home/$(whoami)/index.html /var/www/html/index.html
            # Make sure the permissions are correct for the web server to serve the file
            #sudo chown www-data:www-data /var/www/html/index.html
            #sudo chmod 644 /var/www/html/index.html
          EOF
